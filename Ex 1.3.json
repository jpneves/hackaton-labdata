{"paragraphs":[{"title":"Também é possível acessar diretamente o S3 em vez de ler tabelas","text":"%pyspark\nfrom pyspark.sql.functions import year, month,  dayofmonth, hour\nfrom pyspark.sql.types import DateType\n# substitua o <bucket-name> pelo nome do seu bucket. Coloque ano, mes, dia e hora que exista no seu bucket s3. \n# df = spark.read.json(\"s3://<bucket-name>/rawdata/ano/mes/dia/hora/\")\ndf_raw = spark.read.json(\"s3://time-conta3-demo-ecomm-bucket-stream/rawdata/2020/03/07/13/\")\n\n                       \ndf_raw  = df_raw.withColumn('day', dayofmonth(\"trans_timestamp\")) \\\n                                .withColumn('month', month(\"trans_timestamp\")) \\\n                                .withColumn('year', year(\"trans_timestamp\")) \\\n                                .withColumn('hour', hour(\"trans_timestamp\"))\n                                \ndf_raw.show()","user":"anonymous","dateUpdated":"2020-03-07T19:36:11+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------+----------+------------+------------------+--------------------+-------------------+---+-----+----+----+\n|custid|    device|touchproduct|       trafficfrom|     trans_timestamp|                url|day|month|year|hour|\n+------+----------+------------+------------------+--------------------+-------------------+---+-----+----+----+\n|   440|app_tablet|          18|        BeerHug_TV|2020-03-07T13:16:...|beer_product_detail|  7|    3|2020|  13|\n|   250|   browser|           0|        BeerHug_TV|2020-03-07T13:16:...|   beer_vitrine_nav|  7|    3|2020|  13|\n|   214|app_mobile|           0|email_CampanhaBeer|2020-03-07T13:16:...|   beer_vitrine_nav|  7|    3|2020|  13|\n|   111|   browser|           0|            google|2020-03-07T13:16:...|   beer_vitrine_nav|  7|    3|2020|  13|\n|   546|   browser|         246|        BeerHug_TV|2020-03-07T13:16:...|      beer_checkout|  7|    3|2020|  13|\n|   305|app_tablet|           0|      facebook.com|2020-03-07T13:16:...|   beer_vitrine_nav|  7|    3|2020|  13|\n|   214|   browser|          88| email_MyFirstBeer|2020-03-07T13:16:...|      beer_checkout|  7|    3|2020|  13|\n|   316|app_mobile|          67|      facebook.com|2020-03-07T13:16:...|          beer_cart|  7|    3|2020|  13|\n|   336|app_tablet|         107|        amazon.com|2020-03-07T13:16:...|          beer_cart|  7|    3|2020|  13|\n|   343|   browser|          68|email_CampanhaBeer|2020-03-07T13:16:...|          beer_cart|  7|    3|2020|  13|\n|   217|app_mobile|         197|    Jao_Cervejeiro|2020-03-07T13:16:...|          beer_cart|  7|    3|2020|  13|\n|   321|app_mobile|         212|            google|2020-03-07T13:16:...|      beer_checkout|  7|    3|2020|  13|\n|   230|app_mobile|           0|      facebook.com|2020-03-07T13:16:...|   beer_vitrine_nav|  7|    3|2020|  13|\n|   135|app_mobile|         186|        BeerHug_TV|2020-03-07T13:16:...|beer_product_detail|  7|    3|2020|  13|\n|   102|   browser|         164|        BeerHug_TV|2020-03-07T13:16:...|beer_product_detail|  7|    3|2020|  13|\n|   500|app_mobile|          93|            google|2020-03-07T13:16:...|beer_product_detail|  7|    3|2020|  13|\n|   429|   browser|           1|            google|2020-03-07T13:16:...|beer_product_detail|  7|    3|2020|  13|\n|   119|app_tablet|          95|            google|2020-03-07T13:16:...|      beer_checkout|  7|    3|2020|  13|\n|   231|app_mobile|           0|            google|2020-03-07T13:16:...|   beer_vitrine_nav|  7|    3|2020|  13|\n|   509|   browser|         142|       twitter.com|2020-03-07T13:16:...|beer_product_detail|  7|    3|2020|  13|\n+------+----------+------------+------------------+--------------------+-------------------+---+-----+----+----+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1583601320734_841097354","id":"20181208-134540_1669931981","dateCreated":"2020-03-07T17:15:20+0000","dateStarted":"2020-03-07T19:36:11+0000","dateFinished":"2020-03-07T19:36:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:5230"},{"title":"Renomeando as colunas e inferindo o schema do data source agregado","text":"%pyspark\n\ndf_agg = spark.read.option('inferSchema', 'true').csv(\"s3://time-conta3-demo-ecomm-bucket-stream/aggregated/2020/03/07/14/\")\ndf_agg_renamed = df_agg.withColumnRenamed('_c0', 'sessionid') \\\n                       .withColumnRenamed('_c1', 'userid') \\\n                       .withColumnRenamed('_c2', 'device') \\\n                       .withColumnRenamed('_c3', 'aggreg_time') \\\n                       .withColumnRenamed('_c4', 'events') \\\n                       .withColumnRenamed('_c5', 'beginurl') \\\n                       .withColumnRenamed('_c6', 'endurl') \\\n                       .withColumnRenamed('_c7', 'begin_min_ss') \\\n                       .withColumnRenamed('_c8', 'end_min_ss') \\\n                       .withColumnRenamed('_c9', 'totaltime_sec')\n                       \ndf_agg_renamed  = df_agg_renamed.withColumn('day', dayofmonth(\"aggreg_time\")) \\\n                                .withColumn('month', month(\"aggreg_time\")) \\\n                                .withColumn('year', year(\"aggreg_time\")) \\\n                                .withColumn('hour', hour(\"aggreg_time\"))\ndf_agg_renamed.show()","user":"anonymous","dateUpdated":"2020-03-07T19:36:12+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------------+------+----------+-------------------+------+-------------------+-------------------+------------+----------+-------------+---+-----+----+----+\n|        sessionid|userid|    device|        aggreg_time|events|           beginurl|             endurl|begin_min_ss|end_min_ss|totaltime_sec|day|month|year|hour|\n+-----------------+------+----------+-------------------+------+-------------------+-------------------+------------+----------+-------------+---+-----+----+----+\n|150_APP1583591040|   150|app_mobile|2020-03-07 14:24:00|     4|      beer_checkout|      beer_checkout|       24:10|     24:55|           45|  7|    3|2020|  14|\n|341_APP1583591040|   341|app_mobile|2020-03-07 14:24:00|     1|beer_product_detail|beer_product_detail|       24:10|     24:10|            0|  7|    3|2020|  14|\n|546_APP1583591040|   546|app_tablet|2020-03-07 14:24:00|     3|      beer_checkout|beer_product_detail|       24:10|     24:47|           37|  7|    3|2020|  14|\n|511_BRO1583591040|   511|   browser|2020-03-07 14:24:00|     2|          beer_cart|          beer_cart|       24:10|     24:17|            7|  7|    3|2020|  14|\n|113_APP1583591040|   113|app_tablet|2020-03-07 14:24:00|     2|      beer_checkout|      beer_checkout|       24:10|     24:36|           25|  7|    3|2020|  14|\n|541_BRO1583591040|   541|   browser|2020-03-07 14:24:00|     3|beer_product_detail|   beer_vitrine_nav|       24:10|     24:43|           33|  7|    3|2020|  14|\n|518_APP1583591040|   518|app_tablet|2020-03-07 14:24:00|     3|beer_product_detail|beer_product_detail|       24:10|     24:39|           29|  7|    3|2020|  14|\n|102_APP1583591040|   102|app_mobile|2020-03-07 14:24:00|     2|   beer_vitrine_nav|beer_product_detail|       24:10|     24:52|           41|  7|    3|2020|  14|\n|246_APP1583591040|   246|app_tablet|2020-03-07 14:24:00|     3|   beer_vitrine_nav|      beer_checkout|       24:10|     24:59|           49|  7|    3|2020|  14|\n|530_BRO1583591040|   530|   browser|2020-03-07 14:24:00|     2|   beer_vitrine_nav|   beer_vitrine_nav|       24:10|     24:53|           43|  7|    3|2020|  14|\n|527_BRO1583591040|   527|   browser|2020-03-07 14:24:00|     1|          beer_cart|          beer_cart|       24:10|     24:10|            0|  7|    3|2020|  14|\n|509_BRO1583591040|   509|   browser|2020-03-07 14:24:00|     2|          beer_cart|beer_product_detail|       24:10|     24:17|            6|  7|    3|2020|  14|\n|127_APP1583591040|   127|app_mobile|2020-03-07 14:24:00|     2|   beer_vitrine_nav|   beer_vitrine_nav|       24:10|     24:21|           10|  7|    3|2020|  14|\n|443_BRO1583591040|   443|   browser|2020-03-07 14:24:00|     1|          beer_cart|          beer_cart|       24:10|     24:10|            0|  7|    3|2020|  14|\n|426_BRO1583591040|   426|   browser|2020-03-07 14:24:00|     4|beer_product_detail|      beer_checkout|       24:10|     24:54|           43|  7|    3|2020|  14|\n|118_BRO1583591040|   118|   browser|2020-03-07 14:24:00|     2|beer_product_detail|          beer_cart|       24:10|     24:31|           20|  7|    3|2020|  14|\n|327_BRO1583591040|   327|   browser|2020-03-07 14:24:00|     6|   beer_vitrine_nav|          beer_cart|       24:10|     24:48|           37|  7|    3|2020|  14|\n|121_APP1583591040|   121|app_mobile|2020-03-07 14:24:00|     2|      beer_checkout|   beer_vitrine_nav|       24:11|     24:14|            3|  7|    3|2020|  14|\n|312_APP1583591040|   312|app_tablet|2020-03-07 14:24:00|     2|   beer_vitrine_nav|beer_product_detail|       24:11|     24:35|           23|  7|    3|2020|  14|\n|314_APP1583591040|   314|app_tablet|2020-03-07 14:24:00|     1|beer_product_detail|beer_product_detail|       24:11|     24:11|            0|  7|    3|2020|  14|\n+-----------------+------+----------+-------------------+------+-------------------+-------------------+------------+----------+-------------+---+-----+----+----+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1583601320735_1056540535","id":"20181208-140532_192880319","dateCreated":"2020-03-07T17:15:20+0000","dateStarted":"2020-03-07T19:36:17+0000","dateFinished":"2020-03-07T19:36:22+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5231"},{"title":"Gravar o dataframe em formato parquet em um bucket de destino","text":"%pyspark\nspark.sql('create database if not exists stage')\nDESTINO='s3://time-conta3-demo-ecomm-bucket-stage/ecommerce-events'\ndf_raw.write \\\n    .format(\"json\") \\\n    .mode(\"append\") \\\n    .partitionBy('year', 'month', 'day', 'hour') \\\n    .saveAsTable(\"stage.ecommerce_events\", path=DESTINO)","user":"anonymous","dateUpdated":"2020-03-07T19:38:58+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1583601320735_1856028898","id":"20190412-232253_1471290996","dateCreated":"2020-03-07T17:15:20+0000","dateStarted":"2020-03-07T19:38:58+0000","dateFinished":"2020-03-07T19:39:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5232"},{"text":"%pyspark\nspark.sql('drop table stage.ecommerce_events_agg')\nDESTINO='s3a://time-conta3-demo-ecomm-bucket-stage/ecommerce-events-agg'\ndf_agg_renamed.write \\\n    .format(\"csv\") \\\n    .mode(\"append\") \\\n    .partitionBy('year', 'month', 'day', 'hour') \\\n    .saveAsTable(\"stage.ecommerce_events_agg\", path=DESTINO)","user":"anonymous","dateUpdated":"2020-03-07T19:37:53+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1583604839065_-2110219344","id":"20200307-181359_838486620","dateCreated":"2020-03-07T18:13:59+0000","dateStarted":"2020-03-07T19:37:53+0000","dateFinished":"2020-03-07T19:38:08+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5233"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2020-03-07T19:35:21+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1583609721596_633651266","id":"20200307-193521_467185767","dateCreated":"2020-03-07T19:35:21+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:6549"}],"name":"/JP/Ex 1.3","id":"2F517XYQA","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}